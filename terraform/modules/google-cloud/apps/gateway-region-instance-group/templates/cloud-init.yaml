#cloud-config

package_update: true
package_upgrade: true
package_reboot_if_required: true

packages:
  - apt-transport-https
  - ca-certificates
  - software-properties-common

write_files:
  - path: /etc/apt/keyrings
    permissions: "0755"
    owner: root:root
    content: ""

  - path: /etc/google-cloud-ops-agent/config.yaml
    permissions: "0644"
    owner: root
    content: |
      combined:
        receivers:
          otlp:
            type: otlp
            metrics_mode: googlecloudmonitoring
      metrics:
        service:
          pipelines:
            otlp:
              receivers: [otlp]
      traces:
        service:
          pipelines:
            otlp:
              receivers: [otlp]

  - path: /etc/environment
    content: |
      LOG_FORMAT=google-cloud
      GOOGLE_CLOUD_PROJECT_ID=$(project_id)
      OTLP_GRPC_ENDPOINT=$(otlp_grpc_endpoint)
    append: true

runcmd:
  # Install Ops Agent
  - curl -sSO https://dl.google.com/cloudagents/add-google-cloud-ops-agent-repo.sh
  - sudo bash add-google-cloud-ops-agent-repo.sh --also-install
  # Install Firezone Gateway
  - FIREZONE_TOKEN="${firezone_token}" \
    FIREZONE_API_URL="${firezone_api_url}" \
    FIREZONE_VERSION="${firezone_version}" \
    FIREZONE_ARTIFACT_URL="${firezone_artifact_url}" \
    bash <(curl -fsSL https://raw.githubusercontent.com/firezone/firezone/main/scripts/gateway-systemd-install.sh)
