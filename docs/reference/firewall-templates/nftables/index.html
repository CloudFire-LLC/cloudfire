<!DOCTYPE html> <html lang="en-US"> <body> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>nftables Firewall Template | Docs Firezone</title> <meta name="generator" content="Jekyll v3.9.2" /> <meta property="og:title" content="nftables Firewall Template" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="nftables based firewall template that can be used with Firezone." /> <meta property="og:description" content="nftables based firewall template that can be used with Firezone." /> <link rel="canonical" href="https://docs.firezone.dev/docs/reference/firewall-templates/nftables/" /> <meta property="og:url" content="https://docs.firezone.dev/docs/reference/firewall-templates/nftables/" /> <meta property="og:site_name" content="Docs Firezone" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="nftables Firewall Template" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"nftables based firewall template that can be used with Firezone.","headline":"nftables Firewall Template","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://docs.firezone.dev/assets/images/logo-main.svg"}},"url":"https://docs.firezone.dev/docs/reference/firewall-templates/nftables/"}</script> <!-- End Jekyll SEO tag --> <script defer src="/assets/js/version-selector.js"></script> <!-- PostHog Telemetry --> <script> !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]); posthog.init('phc_ubuPhiqqjMdedpmbWpG2Ak3axqv5eMVhFDNBaXl9UZK',{api_host:'https://telemetry.firez.one'}) </script> <!-- Fonts --> <link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;500;600;700;900&display=swap" rel="stylesheet"> <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet"> <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700;900&display=swap" rel="stylesheet"> </head> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path> <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle> <line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line> <line x1="3" y1="6" x2="21" y2="6"></line> <line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path> <polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="https://docs.firezone.dev/" class="site-title lh-tight"> <div class="site-logo-wrapper"> <div class="site-logo"></div> <h1>Documentation</h1> </div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"> <use xlink:href="#svg-menu"></use> </svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <div class="select-version"> <label> Select version: <select class="version-selector"> </select> </label> </div> <ul class="nav-list"><li class="nav-list-item"><a href="https://docs.firezone.dev/" class="nav-list-link">Overview</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://docs.firezone.dev/docs/deploy/" class="nav-list-link">Deploy</a><ul class="nav-list "><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/deploy/supported-platforms/" class="nav-list-link">Supported Platforms</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/deploy/prerequisites/" class="nav-list-link">Prerequisites</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/deploy/server/" class="nav-list-link">Install Server</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://docs.firezone.dev/docs/authenticate/" class="nav-list-link">Authenticate</a><ul class="nav-list "><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/authenticate/google/" class="nav-list-link">Google</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/authenticate/okta/" class="nav-list-link">Okta</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/authenticate/azure-ad/" class="nav-list-link">Azure Active Directory</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/authenticate/web-auth/" class="nav-list-link">Local Email / Password Authentication</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://docs.firezone.dev/docs/administer/" class="nav-list-link">Administer</a><ul class="nav-list "><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/administer/configure/" class="nav-list-link">Configure</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/administer/manage/" class="nav-list-link">Manage Installation</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/administer/upgrade/" class="nav-list-link">Upgrade</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/administer/uninstall/" class="nav-list-link">Uninstall</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/administer/troubleshoot/" class="nav-list-link">Troubleshoot</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/administer/security-considerations/" class="nav-list-link">Security Considerations</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/administer/running-sql-queries/" class="nav-list-link">Running SQL Queries</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://docs.firezone.dev/docs/user-guides/" class="nav-list-link">User Guides</a><ul class="nav-list "><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/user-guides/add-users/" class="nav-list-link">Add Users</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/user-guides/add-devices/" class="nav-list-link">Add Devices</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/user-guides/firewall-rules/" class="nav-list-link">Firewall Rules</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/user-guides/client-instructions/" class="nav-list-link">Client Instructions</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/user-guides/split-tunnel/" class="nav-list-link">Split Tunnel</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/user-guides/whitelist-vpn/" class="nav-list-link">Using Firezone as a NAT Gateway</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/user-guides/reverse-tunnel/" class="nav-list-link">Reverse Tunnel</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://docs.firezone.dev/docs/reference/" class="nav-list-link">Reference</a><ul class="nav-list "><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/reference/configuration-file/" class="nav-list-link">Configuration File</a></li><li class="nav-list-item "><a href="https://docs.firezone.dev/docs/reference/file-and-directory-locations/" class="nav-list-link">File and Directory Locations</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://docs.firezone.dev/docs/reference/firewall-templates/" class="nav-list-link">Firewall Templates</a><ul class="nav-list"></ul></li></ul></li></ul> </nav> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Docs | Firezone" aria-label="Search Docs | Firezone" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"> <use xlink:href="#svg-search"></use> </svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://discourse.firez.one" class="site-button" > Ask a Question </a> </li> <li class="aux-nav-list-item"> <a href="https://e04kusl9oz5.typeform.com/to/ZPYb31sA#int=docs&source=nav" class="site-button" > Join the Business Beta </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="">Firewall Templates</a></li> <li class="breadcrumb-nav-list-item"><span>nftables Firewall Template</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1>nftables Firewall Template</h1> <hr /> <p>The following nftables firewall template can be used to secure the server running Firezone. The template does make some assumptions; you may need to adjust the rules to suite your use case:</p> <ul> <li>The WireGuard interface is named <code class="language-plaintext highlighter-rouge">wg-firezone</code>. If this is not correct, change the <code class="language-plaintext highlighter-rouge">DEV_WIREGUARD</code> variable to match the <code class="language-plaintext highlighter-rouge">default['firezone']['wireguard']['interface_name']</code> configuration option.</li> <li>The port WireGuard is listening on is <code class="language-plaintext highlighter-rouge">51820</code>. If you are not using the default port change the <code class="language-plaintext highlighter-rouge">WIREGUARD_PORT</code> variable.</li> <li>Only the following inbound traffic will be allowed to the server: <ul> <li>SSH (TCP dport 22)</li> <li>HTTP (TCP dport 80)</li> <li>HTTPS (TCP dport 443)</li> <li>WireGuard (UDP dport <code class="language-plaintext highlighter-rouge">WIREGUARD_PORT</code>)</li> <li>UDP traceroute (UDP dport 33434-33524, rate limited to 500/second)</li> <li>ICMP and ICMPv6 (ping/ping responses rate limited to 2000/second)</li> </ul> </li> <li>Only the following outbound traffic will be allowed from the server: <ul> <li>DNS (UDP and TCP dport 53)</li> <li>HTTP (TCP dport 80)</li> <li>NTP (UDP port 123)</li> <li>HTTPS (TCP dport 443)</li> <li>SMTP submission (TCP dport 587)</li> <li>UDP traceroute (UDP dport 33434-33524, rate limited to 500/second)</li> </ul> </li> <li>Unmatched traffic will be logged. The rules used for logging are separated from the rules to drop traffic and are rate limited. Removing the relevant logging rules will not affect trafic.</li> </ul> <h2 id="firezone-managed-rules"> <a href="#firezone-managed-rules" class="anchor-heading" aria-labelledby="firezone-managed-rules"><svg viewBox="0 0 16 16" aria-hidden="true"> <use xlink:href="#svg-link"></use> </svg></a> Firezone-managed Rules </h2> <p>Firezone configures its own nftables rules to permit/reject traffic to destinations configured in the web interface and to handle outbound NAT for client traffic.</p> <p>Applying the below firewall template on an already running server (not at boot time) will result in the Firezone rules being cleared. This may have security implications.</p> <p>To work around this restart the <code class="language-plaintext highlighter-rouge">phoenix</code> service:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>firezone-ctl restart phoenix
</code></pre></div></div> <h2 id="base-firewall-template"> <a href="#base-firewall-template" class="anchor-heading" aria-labelledby="base-firewall-template"><svg viewBox="0 0 16 16" aria-hidden="true"> <use xlink:href="#svg-link"></use> </svg></a> Base Firewall Template </h2> <!-- markdownlint-disable MD013 --> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/sbin/nft -f</span>

<span class="c">## Clear/flush all existing rules</span>
flush ruleset

<span class="c">################################ VARIABLES ################################</span>
<span class="c">## Internet/WAN interface name</span>
define DEV_WAN <span class="o">=</span> eth0

<span class="c">## WireGuard interface name</span>
define DEV_WIREGUARD <span class="o">=</span> wg-firezone

<span class="c">## WireGuard listen port</span>
define WIREGUARD_PORT <span class="o">=</span> 51820
<span class="c">############################## VARIABLES END ##############################</span>

<span class="c"># Main inet family filtering table</span>
table inet filter <span class="o">{</span>

  <span class="c"># Rules for forwarded traffic</span>
  <span class="c"># This chain is processed before the Firezone forward chain</span>
  chain forward <span class="o">{</span>
    <span class="nb">type </span>filter hook forward priority filter - 5<span class="p">;</span> policy accept
  <span class="o">}</span>

  <span class="c"># Rules for input traffic</span>
  chain input <span class="o">{</span>
    <span class="nb">type </span>filter hook input priority filter<span class="p">;</span> policy drop

    <span class="c">## Permit inbound traffic to loopback interface</span>
    iif lo <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit all traffic in from loopback interface"</span>

    <span class="c">## Permit established and related connections</span>
    ct state established,related <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit established/related connections"</span>

    <span class="c">## Permit inbound WireGuard traffic</span>
    iif <span class="nv">$DEV_WAN</span> udp dport <span class="nv">$WIREGUARD_PORT</span> <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit inbound WireGuard traffic"</span>

    <span class="c">## Log and drop new TCP non-SYN packets</span>
    tcp flags <span class="o">!=</span> syn ct state new <span class="se">\</span>
      limit rate 100/minute burst 150 packets <span class="se">\</span>
      log prefix <span class="s2">"IN - New !SYN: "</span> <span class="se">\</span>
      comment <span class="s2">"Rate limit logging for new connections that do not have the SYN TCP flag set"</span>
    tcp flags <span class="o">!=</span> syn ct state new <span class="se">\</span>
      counter <span class="se">\</span>
      drop <span class="se">\</span>
      comment <span class="s2">"Drop new connections that do not have the SYN TCP flag set"</span>

    <span class="c">## Log and drop TCP packets with invalid fin/syn flag set</span>
    tcp flags &amp; <span class="o">(</span>fin|syn<span class="o">)</span> <span class="o">==</span> <span class="o">(</span>fin|syn<span class="o">)</span> <span class="se">\</span>
      limit rate 100/minute burst 150 packets <span class="se">\</span>
      log prefix <span class="s2">"IN - TCP FIN|SIN: "</span> <span class="se">\</span>
      comment <span class="s2">"Rate limit logging for TCP packets with invalid fin/syn flag set"</span>
    tcp flags &amp; <span class="o">(</span>fin|syn<span class="o">)</span> <span class="o">==</span> <span class="o">(</span>fin|syn<span class="o">)</span> <span class="se">\</span>
      counter <span class="se">\</span>
      drop <span class="se">\</span>
      comment <span class="s2">"Drop TCP packets with invalid fin/syn flag set"</span>

    <span class="c">## Log and drop TCP packets with invalid syn/rst flag set</span>
    tcp flags &amp; <span class="o">(</span>syn|rst<span class="o">)</span> <span class="o">==</span> <span class="o">(</span>syn|rst<span class="o">)</span> <span class="se">\</span>
      limit rate 100/minute burst 150 packets <span class="se">\</span>
      log prefix <span class="s2">"IN - TCP SYN|RST: "</span> <span class="se">\</span>
      comment <span class="s2">"Rate limit logging for TCP packets with invalid syn/rst flag set"</span>
    tcp flags &amp; <span class="o">(</span>syn|rst<span class="o">)</span> <span class="o">==</span> <span class="o">(</span>syn|rst<span class="o">)</span> <span class="se">\</span>
      counter <span class="se">\</span>
      drop <span class="se">\</span>
      comment <span class="s2">"Drop TCP packets with invalid syn/rst flag set"</span>

    <span class="c">## Log and drop invalid TCP flags</span>
    tcp flags &amp; <span class="o">(</span>fin|syn|rst|psh|ack|urg<span class="o">)</span> &lt; <span class="o">(</span>fin<span class="o">)</span> <span class="se">\</span>
      limit rate 100/minute burst 150 packets <span class="se">\</span>
      log prefix <span class="s2">"IN - FIN:"</span> <span class="se">\</span>
      comment <span class="s2">"Rate limit logging for invalid TCP flags (fin|syn|rst|psh|ack|urg) &lt; (fin)"</span>
    tcp flags &amp; <span class="o">(</span>fin|syn|rst|psh|ack|urg<span class="o">)</span> &lt; <span class="o">(</span>fin<span class="o">)</span> <span class="se">\</span>
      counter <span class="se">\</span>
      drop <span class="se">\</span>
      comment <span class="s2">"Drop TCP packets with flags (fin|syn|rst|psh|ack|urg) &lt; (fin)"</span>

    <span class="c">## Log and drop invalid TCP flags</span>
    tcp flags &amp; <span class="o">(</span>fin|syn|rst|psh|ack|urg<span class="o">)</span> <span class="o">==</span> <span class="o">(</span>fin|psh|urg<span class="o">)</span> <span class="se">\</span>
      limit rate 100/minute burst 150 packets <span class="se">\</span>
      log prefix <span class="s2">"IN - FIN|PSH|URG:"</span> <span class="se">\</span>
      comment <span class="s2">"Rate limit logging for invalid TCP flags (fin|syn|rst|psh|ack|urg) == (fin|psh|urg)"</span>
    tcp flags &amp; <span class="o">(</span>fin|syn|rst|psh|ack|urg<span class="o">)</span> <span class="o">==</span> <span class="o">(</span>fin|psh|urg<span class="o">)</span> <span class="se">\</span>
      counter <span class="se">\</span>
      drop <span class="se">\</span>
      comment <span class="s2">"Drop TCP packets with flags (fin|syn|rst|psh|ack|urg) == (fin|psh|urg)"</span>

    <span class="c">## Drop traffic with invalid connection state</span>
    ct state invalid <span class="se">\</span>
      limit rate 100/minute burst 150 packets <span class="se">\</span>
      log flags all prefix <span class="s2">"IN - Invalid: "</span> <span class="se">\</span>
      comment <span class="s2">"Rate limit logging for traffic with invalid connection state"</span>
    ct state invalid <span class="se">\</span>
      counter <span class="se">\</span>
      drop <span class="se">\</span>
      comment <span class="s2">"Drop traffic with invalid connection state"</span>

    <span class="c">## Permit IPv4 ping/ping responses but rate limit to 2000 PPS</span>
    ip protocol icmp icmp <span class="nb">type</span> <span class="o">{</span> echo-reply, echo-request <span class="o">}</span> <span class="se">\</span>
      limit rate 2000/second <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit inbound IPv4 echo (ping) limited to 2000 PPS"</span>

    <span class="c">## Permit all other inbound IPv4 ICMP</span>
    ip protocol icmp <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit all other IPv4 ICMP"</span>

    <span class="c">## Permit IPv6 ping/ping responses but rate limit to 2000 PPS</span>
    icmpv6 <span class="nb">type</span> <span class="o">{</span> echo-reply, echo-request <span class="o">}</span> <span class="se">\</span>
      limit rate 2000/second <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit inbound IPv6 echo (ping) limited to 2000 PPS"</span>

    <span class="c">## Permit all other inbound IPv6 ICMP</span>
    meta l4proto <span class="o">{</span> icmpv6 <span class="o">}</span> <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit all other IPv6 ICMP"</span>

    <span class="c">## Permit inbound traceroute UDP ports but limit to 500 PPS</span>
    udp dport 33434-33524 <span class="se">\</span>
      limit rate 500/second <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit inbound UDP traceroute limited to 500 PPS"</span>

    <span class="c">## Permit inbound SSH</span>
    tcp dport ssh ct state new <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit inbound SSH connections"</span>

    <span class="c">## Permit inbound HTTP and HTTPS</span>
    tcp dport <span class="o">{</span> http, https <span class="o">}</span> ct state new <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit inbound HTTP and HTTPS connections"</span>

    <span class="c">## Log any unmatched traffic but rate limit logging to a maximum of 60 messages/minute</span>
    <span class="c">## The default policy will be applied to unmatched traffic</span>
    limit rate 60/minute burst 100 packets <span class="se">\</span>
      log prefix <span class="s2">"IN - Drop: "</span> <span class="se">\</span>
      comment <span class="s2">"Log any unmatched traffic"</span>

    <span class="c">## Count the unmatched traffic</span>
    counter <span class="se">\</span>
      comment <span class="s2">"Count any unmatched traffic"</span>
  <span class="o">}</span>

  <span class="c"># Rules for output traffic</span>
  chain output <span class="o">{</span>
    <span class="nb">type </span>filter hook output priority filter<span class="p">;</span> policy drop

    <span class="c">## Permit outbound traffic to loopback interface</span>
    oif lo <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit all traffic out to loopback interface"</span>

    <span class="c">## Permit established and related connections</span>
    ct state established,related <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit established/related connections"</span>

    <span class="c">## Permit outbound WireGuard traffic before dropping connections with bad state</span>
    oif <span class="nv">$DEV_WAN</span> udp sport <span class="nv">$WIREGUARD_PORT</span> <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit WireGuard outbound traffic"</span>

    <span class="c">## Drop traffic with invalid connection state</span>
    ct state invalid <span class="se">\</span>
      limit rate 100/minute burst 150 packets <span class="se">\</span>
      log flags all prefix <span class="s2">"OUT - Invalid: "</span> <span class="se">\</span>
      comment <span class="s2">"Rate limit logging for traffic with invalid connection state"</span>
    ct state invalid <span class="se">\</span>
      counter <span class="se">\</span>
      drop <span class="se">\</span>
      comment <span class="s2">"Drop traffic with invalid connection state"</span>

    <span class="c">## Permit all other outbound IPv4 ICMP</span>
    ip protocol icmp <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit all IPv4 ICMP types"</span>

    <span class="c">## Permit all other outbound IPv6 ICMP</span>
    meta l4proto <span class="o">{</span> icmpv6 <span class="o">}</span> <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit all IPv6 ICMP types"</span>

    <span class="c">## Permit outbound traceroute UDP ports but limit to 500 PPS</span>
    udp dport 33434-33524 <span class="se">\</span>
      limit rate 500/second <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit outbound UDP traceroute limited to 500 PPS"</span>

    <span class="c">## Permit outbound HTTP and HTTPS connections</span>
    tcp dport <span class="o">{</span> http, https <span class="o">}</span> ct state new <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit outbound HTTP and HTTPS connections"</span>

    <span class="c">## Permit outbound SMTP submission</span>
    tcp dport submission ct state new <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit outbound SMTP submission"</span>

    <span class="c">## Permit outbound DNS requests</span>
    udp dport 53 <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit outbound UDP DNS requests"</span>
    tcp dport 53 <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit outbound TCP DNS requests"</span>

    <span class="c">## Permit outbound NTP requests</span>
    udp dport 123 <span class="se">\</span>
      counter <span class="se">\</span>
      accept <span class="se">\</span>
      comment <span class="s2">"Permit outbound NTP requests"</span>

    <span class="c">## Log any unmatched traffic but rate limit logging to a maximum of 60 messages/minute</span>
    <span class="c">## The default policy will be applied to unmatched traffic</span>
    limit rate 60/minute burst 100 packets <span class="se">\</span>
      log prefix <span class="s2">"OUT - Drop: "</span> <span class="se">\</span>
      comment <span class="s2">"Log any unmatched traffic"</span>

    <span class="c">## Count the unmatched traffic</span>
    counter <span class="se">\</span>
      comment <span class="s2">"Count any unmatched traffic"</span>
  <span class="o">}</span>

<span class="o">}</span>

<span class="c"># Main NAT filtering table</span>
table inet nat <span class="o">{</span>

  <span class="c"># Rules for NAT traffic pre-routing</span>
  chain prerouting <span class="o">{</span>
    <span class="nb">type </span>nat hook prerouting priority dstnat<span class="p">;</span> policy accept
  <span class="o">}</span>

  <span class="c"># Rules for NAT traffic post-routing</span>
  <span class="c"># This table is processed before the Firezone post-routing chain</span>
  chain postrouting <span class="o">{</span>
    <span class="nb">type </span>nat hook postrouting priority srcnat - 5<span class="p">;</span> policy accept
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div> <!-- markdownlint-enable MD013 --> <h2 id="usage"> <a href="#usage" class="anchor-heading" aria-labelledby="usage"><svg viewBox="0 0 16 16" aria-hidden="true"> <use xlink:href="#svg-link"></use> </svg></a> Usage </h2> <p>The firewall should be stored in the relevant location for the Linux distribution that is running. For Debian/Ubuntu this is <code class="language-plaintext highlighter-rouge">/etc/nftables.conf</code> and for RHEL this is <code class="language-plaintext highlighter-rouge">/etc/sysconfig/nftables.conf</code>.</p> <p><code class="language-plaintext highlighter-rouge">nftables.service</code> will need to be configured to start on boot (if not already) set:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl <span class="nb">enable </span>nftables.service
</code></pre></div></div> <p>If making any changes to the firewall template the syntax can be validated by running the check command:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nft <span class="nt">-f</span> /path/to/nftables.conf <span class="nt">-c</span>
</code></pre></div></div> <p>Be sure to validate the firewall works as expected as certain nftables features may not be available depending on the release running on the server.</p> <hr> <footer> <div class="mb-0"> <p> WireGuard® is a registered trademark of Jason A. Donenfeld. </p> <p> For support, first visit our <a href="https://discourse.firez.one/">Discussion Forums</a> </p> <a href="https://www.firezone.dev/">Company</a> | <a href="https://github.com/firezone/">Github</a> | <a href="https://twitter.com/firezonehq/">Twitter</a> </div> <div class="d-flex mt-2"> <p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/firezone/firezone/tree/master/docs/docs/reference/firewall-templates/nftables.md" id="edit-this-page">Edit on GitHub</a> </p> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
