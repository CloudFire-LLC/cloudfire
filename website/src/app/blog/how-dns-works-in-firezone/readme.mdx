Firezone's DNS routing system works a bit differently than one might expect. One
question we commonly get from new users is,

> why do my DNS Resources resolve to a different IP address with Firezone
> enabled?

The answer is that Firezone includes a sophisticated DNS routing system that was
designed to address some of the security pitfalls organizations face when
deploying DNS across their workforce.

This post aims to explain how DNS works in Firezone, why it's designed the way
it is, and how that keeps your organization secure. Ready? Let's get started.

## A brief history lesson

To grasp some of the security issues that can arise from poorly configured DNS,
we first need to understand the problem DNS was built to solve. Time for a
history lesson!

DNS was originally conceived to solve a classic scalability problem.

Hosts on the ARPANET (the precursor to the modern internet) were numbered using
IPv4 addresses. To avoid having to remember the IP address for each host you
wanted to connect to, a centralized database was used to store a mapping between
every host's IPv4 address and a human-friendly hostname.

Makes sense so far, right? But where was this database stored, and how was it
updated?

The database for this early system was literally just a single text file (aptly
named `HOSTS.TXT`) stored on a central system managed jointly by the Stanford
Research Institute (SRI) and Network Information Center (NIC) [1].

<p className="text-xs text-center mx-auto">
  Figure 1: Artist's rendition of the original HOSTS.TXT file
</p>

Whenever an ARPANET member organization wanted to add a host to the file or
update its IP address, it needed to contact the SRI (during standard business
hours!) and file a request containing the updated information.

The system worked great when there were only a handful of hosts to maintain. But
as you might imagine, it quickly started to become untenable as more and more
organizations connected their machines to the ARPANET.

The problem was especially apparent with computer mail (known today as email).
The `user@host.domain` system had not been standardized yet, so computer mail
providers resorted to creating "an increasingly large and irregular set of
methods for identifying the location of a mailbox" [2].

It was clear a solution was needed, and fast -- the ARPANET was quickly growing.
Members of the Internet Engineering Task Force (IETF) gathered to discuss
possible solutions to the problem.

## Enter the Domain Name System (DNS)

Over the course of several meetings, IETF engineers devised a clever solution to
the scalability problem they were facing: instead of storing hostnames and IPs
in a single, central `HOSTS.TXT` file, they would instead be split and stored
across multiple "Name Servers", each one responsible for maintaining hosts that
belonged to a particular network, or "Domain".

This is in fact where DNS gets its name -- it is quite literally the Domain Name
System.

### How DNS works

So how does it work?

DNS is a heirarchical system that distributes the responsibility of resolving a
a fully-qualified domain name (FQDN) to a series of nameservers.

<p className="text-xs text-center mx-auto">Figure 2: How DNS works</p>

1. The first stop for a query is typically the stub resolver on the host itself.
   This is a small piece of software that runs on the host and is responsible
   for sending DNS queries to an upstream resolver.
1. If the stub resolver doesn't know the answer to the query, it forwards the
   query to an _upstream resolver_. This is typically a caching resolver that
   has a list of root nameservers it can query.
1. The upstream resolver forwards the query to a root nameserver. The root
   nameserver is the top of the DNS hierarchy and knows the IP addresses of the
   TLD nameservers for each top-level domain (TLD).
1. The root nameserver responds with the IP address of the TLD nameserver for
   the root in question, for example `COM.`. The upstream resolver then forwards
   the query to the TLD nameserver.
1. The TLD nameserver responds with the IP address of the authoritative
   nameserver for the domain in question. This is the nameserver the owner of
   the domain will configure to respond to queries for that domain. It's where
   you typically configure your DNS records for your domain.
1. The upstream resolver forwards the query to the authoritative nameserver.
1. The authoritative nameserver responds with the IP address of the host in
   question, and the upstream resolver returns this to the stub resolver on the
   host that made the original query.
1. The host can now connect to the IP address returned by the authoritative
   nameserver.

The system of root, TLD, and authoritate nameservers replace the function of the
original "HOSTS.TXT" file maintained by NIC in the ARPANET. However, now it's
effectively distributed -- no one server or organization is responsible for
maintaining the entire database, and the system can scale as the internet grows.

Caching resolvers also help to speed up the process by storing the results of
queries for a certain amount of time. This means that if a host makes the same
query multiple times, the resolver can return the result immediately without
having to query the hierarchy of root, TLD, and authoritative nameservers again.

And thus, the email addressing problem above is then solved by prepending the
user's name followed by an `@` character, like so: `USER@HOST.DOMAIN`.

### Security issues with DNS

Over the years, however, security issues started to become apparent. One obvious
one is that you have to trust the nameservers you're querying. If a malicious
actor manages to compromise a nameserver, they can return false responses to
your queries. This is known as a _DNS Spoofing_ attack.

Since your machine has no other way to verify the authoritative answer, it will
happily connect to whatever IP address the malicious nameserver returned.

Another major issue is the lack of encryption in the DNS protocol. DNS queries
are sent in plaintext, which means that anyone who can intercept your network
traffic can see what websites you're visiting. This is known as a _DNS
eavesdropping_ attack.

In more recent years, various solutions have been proposed to address these
shortcomings. One of the most popular is DNS over HTTPS (DoH), which encrypts
DNS queries using the HTTPS protocol.

But there's a still a really big problem with DNS that isn't directly addressed
by these solutions: queries are unauthenticated. This means that anyone can send
a query to a nameserver and get a response, even if they're not authorized to
access the resource they're asking for.

If an organization defines a DNS record for an internal service, for example,
anyone on the outside world can query its nameservers and map out the internal
network topology. This is known as a _DNS enumeration_ attack. Makes the perfect
target hit list for an attacker, doesn't it?

Because of this issue, organizations often resort to using a VPN to tunnel DNS
queries to a trusted nameserver. This is commonly known as _Split DNS_, or
_split-horizon DNS_.

## How Split DNS works

Split DNS is a technique wherein an orgnization maintains two (or more) separate
DNS servers (or zones) -- one for internal resources and one for external
resources. The internal server is only accessible to users who are connected to
an organization's internal network, while the external zone is accessible to the
outside world.

As an example, let's say an organization has an internal service called
`gitlab.company.com`. The organization's internal DNS server would be configured
to respond to queries for this service, but the external DNS server would not.
This allows the organization to isolate resolution for its public services like
`www.company.com` without revealing the internal services to the outside world.

Split DNS works well for organizations that want to secure access to their own
internal applications, and continues to be a popular choice for many companies.

So far, so good right?

### The problem with Split DNS

Increasingly, however, organizations are moving to the cloud and adopting use of
public SaaS apps like Slack, GitHub, and Hubspot. These services are hosted on
the public internet and are not part of the organization's internal network.

Organizations will often set up IP allowlists with these services, and then
route their employees' traffic through the VPN tunnel so that it appears to be
coming from one of the allowed IP addresses.

If the organization can't resolve the DNS queries for these services, however,
they can't route the traffic through the VPN tunnel.

The intrepid reader will be quick to point out a solution to this problem: can't
the organization simply tunnel the resolved IP addresses of these services
through the VPN, just like they do with internal services?

As it turns out, this is a bit more complicated than it seems.

If the service uses Name-based virtual hosting, for example, the IP address that
the DNS query resolves to is shared among many different services, and not just
the one the organization is interested in.

This means that an organization wishing to route DNS traffc for `github.com`
might inadvertently route traffic for _other_ GitHub services running on the
same IPs!

Ok, but what about another solution: can the organization simply configure its
client devices to use the organization's DNS server to respond with internal IP
addresses for the public services?

This is a bit better -- it solves the problem of routing traffic for the wrong
service, but it introduces a new problem: the organization now needs to maintain
a list of all the public services its employees use and configure its DNS server
to respond with the correct IP internal addresses for each one. On top of that,
the organization needs to run operate NAT gateway to route the traffic out to
the actual service IP for the SaaS in question.

## Firezone's DNS routing system

Firezone's DNS routing system was designed to address both the insecurity of
DNS, and the shortcomings of Split DNS, into a single solution that's just as
secure as Split DNS, but much more flexible and easier to manage.

### How it works

When a user signs in, the Firezone Client configures its host operating system
to use a special, lightweight DNS proxy running inside the Client for all DNS
queries on the system.

This proxy lives at `100.100.111.0/24` for IPv4 queries and
`fd00:2021:1111:8000:100:100:111:0/120` for IPv6 queries. These addresses are
not routable on the public internet and are only used for DNS queries.

```text
user@host:~ % dig ifconfig.net

; <<>> DiG 9.10.6 <<>> ifconfig.net
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 51756
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;ifconfig.net.			IN	A

;; ANSWER SECTION:
ifconfig.net.		300	IN	A	100.96.0.2
ifconfig.net.		300	IN	A	100.96.0.1

;; Query time: 262 msec
;; SERVER: fd00:2021:1111:8000:100:100:111:0#53(fd00:2021:1111:8000:100:100:111:0)
;; WHEN: Sat Feb 17 14:04:40 PST 2024
;; MSG SIZE  rcvd: 86
```

The IP addresses the proxy chooses to "listen on" are determined by the
[upstream resolvers](#configuring-client-dns-upstream-resolvers) available to
the Client. For each IPv4 upstream resolver, the proxy listens on an address in
the `100.100.111.0/24` range, and for each IPv6 upstream resolver, the proxy
listens on an address in the `fd00:2021:1111:8000:100:100:111:0/120` range.

When an application makes a DNS query, the proxy checks if the name matches a
Firezone Resource that the user has access to. If it does, the Client then
requests a Gateway serving that Resource to resolve the DNS query. When the
Gateway responds, the proxy will create a temporary mapping between the actual
IP address of the Resource and the dummy IP address it returned to the
application. From this point onward, all subsequent packets to the dummy IP
address are forwarded to the Gateway that resolved the query. These IPs are
persisted for the duration of the Client's session.

immediately responds with appropriate dummy IPs in the `100.64.96.0/11` and
`fd00:2021:1111:8000/108` range and returns these to the application making the
query. These IPs are remembered for the duration of the Client's session and
used to intelligently route subsequent packets to a Firezone Gateway suitable
for serving that Resource.

If the proxy sees a query for a name that **is not** a Firezone Resource that
the user has access to, it will forward the query to the upstream DNS server(s)
configured by the admin in `Settings` -> `DNS`. If no upstream DNS servers are
configured, the query is forwarded to the Client device's default system
resolver(s) instead.

This means that Clients are automatically configured for Split DNS in Firezone
-- no other configuration is necessary other than adding the desired Resources
in the admin portal.

### References

1.
1. _Domain Names - Concepts and Facilities_,
   https://datatracker.ietf.org/doc/html/rfc882
1.
