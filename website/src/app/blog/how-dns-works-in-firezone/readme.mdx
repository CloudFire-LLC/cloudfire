# How DNS Routing Works

Firezone's DNS routing system works a bit differently than one might expect. One
question we commonly get from users new to Firezone is, "why do my DNS Resources
resolve to a different IP address with Firezone enabled?". The answer is that
Firezone includes a sophisticated DNS routing system that was designed to
address some of the security pitfalls organizations face when deploying DNS
across their workforce.

This post aims to explain how DNS works in Firezone, why it's designed the way
it is, and how that keeps your organization secure.

## A brief history lesson

To grasp some of the security issues that can arise from poorly configured DNS,
we first need to understand the problem DNS was built to solve. Time for a
history lesson!

DNS was originally conceived to solve a classic scalability problem.

Hosts on the ARPANET (the precursor to the modern internet) were numbered using
IPv4 addresses. To avoid having to remember the IP address for each host you
wanted to connect to, a centralized database was used to store a mapping between
every host's IPv4 address and a human-friendly hostname.

Makes sense so far, right? But where was this database stored, and how was it
updated?

The database for this early system was literally just a single text file (aptly
named `HOSTS.TXT`) stored on a central system managed jointly by the Stanford
Research Institute (SRI) and Network Information Center (NIC) [1].

<p className="text-xs text-center mx-auto">
  Figure 1: Artist's rendition of the original HOSTS.TXT file
</p>

Whenever an ARPANET member organization wanted to add a host to the file or
update its IP address, it needed to contact the SRI (during standard business
hours!) and file a request containing the updated information.

The system worked great when there were only a handful of hosts to maintain. But
as you might imagine, it quickly started to become untenable as more and more
organizations connected their machines to the ARPANET.

The problem was especially apparent with computer mail (known today as email).
The `user@host.domain` system had not been standardized yet, so computer mail
providers resorted to creating "an increasingly large and irregular set of
methods for identifying the location of a mailbox" [2].

It was clear a solution was needed, and fast -- the ARPANET was quickly growing.
Members of the Internet Engineering Task Force (IETF) gathered to discuss
possible solutions to the problem.

## Enter the Domain Name System (DNS)

Over the course of several meetings, IETF engineers devised a clever solution to
the scalability problem they were facing: instead of storing hostnames and IPs
in a single, central `HOSTS.TXT` file, they would instead be split and stored
across multiple "Name Servers", each one responsible for maintaining hosts that
belonged to a particular network, or "Domain".

This is in fact where DNS gets its name -- it is quite literally the Domain Name
System.

### How DNS works

So how does it work?

To achieve the distributed database design the IETF engineers came up with, DNS
uses a _recursive resolver_ mechanism which, in a simplified way, works as
follows:

<p className="text-xs text-center mx-auto">Figure 2: How DNS works</p>

1. Each host specifies a DNS nameserver to use for queries.
1. When an application on the machine wants to connect to another host, it asks
   the nameserver what the address of the other host is.
1. If the nameserver knows the address (perhaps another host recently asked it),
   it responds with what it knows.
1. If it doesn't know the address, well it turns out the nameserver host itself
   has _another_ nameserver defined. So it asks this nameserver. If the next
   nameserver doesn't know the address, the process is repeated until the query
   lands at what are known as a _root server_.

Root Servers, in some sense, replace the original master hosts file that the NIC
maintained in the early ARPA Internet. But with one big difference: for a query
to reach a root server, it has first traversed a tree-like structure of leaf
resolvers.

This system lends itself well to deduplication: if two or more hosts on the ARPA
Internet queried for the same name, the reply would come from their nearest
common ancestor, and not a root server.

The email addressing problem above is then solved by prepending the user's name
followed by an `@` character, like so: `USER@HOST.DOMAIN`.

### Security issues with DNS

Over the years, DNS has seen its fair share of security issues. 

## How Split DNS solves these problems

When a user signs in, the Firezone Client configures its host operating system
to use a special, lightweight DNS proxy running inside the Client for all DNS
queries on the system.

This proxy lives at `100.100.111.0/24` for IPv4 queries and
`fd00:2021:1111:8000:100:100:111:0/120` for IPv6 queries. These addresses are
not routable on the public internet and are only used for DNS queries.

```text
user@host:~ % dig ifconfig.net

; <<>> DiG 9.10.6 <<>> ifconfig.net
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 51756
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;ifconfig.net.			IN	A

;; ANSWER SECTION:
ifconfig.net.		300	IN	A	100.96.0.2
ifconfig.net.		300	IN	A	100.96.0.1

;; Query time: 262 msec
;; SERVER: fd00:2021:1111:8000:100:100:111:0#53(fd00:2021:1111:8000:100:100:111:0)
;; WHEN: Sat Feb 17 14:04:40 PST 2024
;; MSG SIZE  rcvd: 86
```

The IP addresses the proxy chooses to "listen on" are determined by the
[upstream resolvers](#configuring-client-dns-upstream-resolvers) available to
the Client. For each IPv4 upstream resolver, the proxy listens on an address in
the `100.100.111.0/24` range, and for each IPv6 upstream resolver, the proxy
listens on an address in the `fd00:2021:1111:8000:100:100:111:0/120` range.

When an application makes a DNS query, the proxy checks if the name matches a
Firezone Resource that the user has access to. If it does, the Client then
requests a Gateway serving that Resource to resolve the DNS query. When the
Gateway responds, the proxy will create a temporary mapping between the actual
IP address of the Resource and the dummy IP address it returned to the
application. From this point onward, all subsequent packets to the dummy IP
address are forwarded to the Gateway that resolved the query. These IPs are
persisted for the duration of the Client's session.

immediately responds with appropriate dummy IPs in the `100.64.96.0/11` and
`fd00:2021:1111:8000/108` range and returns these to the application making the
query. These IPs are remembered for the duration of the Client's session and
used to intelligently route subsequent packets to a Firezone Gateway suitable
for serving that Resource.

If the proxy sees a query for a name that **is not** a Firezone Resource that
the user has access to, it will forward the query to the upstream DNS server(s)
configured by the admin in `Settings` -> `DNS`. If no upstream DNS servers are
configured, the query is forwarded to the Client device's default system
resolver(s) instead.

This means that Clients are automatically configured for Split DNS in Firezone
-- no other configuration is necessary other than adding the desired Resources
in the admin portal.

### References

1.
1. _Domain Names - Concepts and Facilities_,
   https://datatracker.ietf.org/doc/html/rfc882
1.
