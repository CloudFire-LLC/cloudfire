import Alert from "@/components/DocsAlert";
import SupportOptions from "@/components/SupportOptions";
import NextStep from "@/components/NextStep";
import PlanBadge from "@/components/PlanBadge";

<PlanBadge plans={["starter", "enterprise"]}>

# Deploy Gateways

</PlanBadge>

Gateways are what clients connect to in order to access resources in a site.
They're the data plane workhorse of the Firezone architecture and are
responsible for securely routing traffic between clients and resources.

## Prerequisites

- Any Linux distribution with kernel 3.10 or later
- Docker Engine (for docker-based installs)
- Systemd (for systemd-based installs)

### Firewall considerations

Gateways implement the industry-standard
[STUN](https://datatracker.ietf.org/doc/html/rfc8489) and
[TURN](https://www.rfc-editor.org/rfc/rfc8155.html) protocols to securely
perform NAT holepunching. No ingress firewall ports are required for Gateways to
function.

If the network in which your Gateway is deployed performs egress filtering,
you'll need to make sure the following outbound traffic is allowed:

| Host             | (IP Address)         | Port(s)         | Protocol(s)     | Purpose                    |
| ---------------- | -------------------- | --------------- | --------------- | -------------------------- |
| api.firezone.dev | `34.102.202.25`      | `443`           | HTTPS/WebSocket | Control Plane API (IPv4)   |
| api.firezone.dev | `2600:1901:0:620b::` | `443`           | HTTPS/WebSocket | Control Plane API (IPv6)   |
| N/A              | Varies               | `3478`          | STUN            | STUN protocol signaling    |
| N/A              | Varies               | `49152 - 65535` | TURN            | TURN protocol channel data |

### Where to deploy Gateways

Ideally, Gateways should be deployed as close to the resources they're serving
-- in some cases, even on the same physical host. This ensures the lowest
possible latency and highest possible throughput for client connections, and
allows you to more easily deploy additional gateways for a particular resource
that needs to handle more client connections.

The downside of deploying gateways close to resources is that it increases the
number of overall gateways you need to deploy, possibly making it more difficult
to manage and monitor them. Firezone's control plane is designed to make this as
easy as possible, but it's still something to keep in mind when planning your
deployment.

### Sizing recommendations

Gateways, like the rest of Firezone's data plane stack, are written in Rust and
are thus resource efficient by nature.

A single client connection to a single gateway can typically reach speeds of **1
Gbps** or more. This scales linearly with each client connection up to the
number of CPU cores available to the Gateway.

Use the table below as a rough guide for sizing your gateway deployments:

| Gateway size | Users served | CPU cores | Memory | Network link |
| ------------ | ------------ | --------- | ------ | ------------ |
| Small        | 100          | 2         | 2 GB   | 1 Gbps       |
| Medium       | 1,000        | 8         | 8 GB   | 10 Gbps      |
| Large        | 10,000       | 32        | 32 GB  | 40 Gbps      |

To go beyond the table above, you can deploy additional Gateways and use
Firezone's [automatic load balancing](#load-balancing) to distribute client
connections across them.

## Deploy a single gateway

Deploying a single gateway can be accomplished in the admin portal.

Go to `Sites` -> `<name of site>` -> `Deploy a Gateway` and follow the prompts
to deploy for your preferred environment. This will deploy a single gateway.

See the [upgrading guide](/kb/administer/upgrading) for information on keeping
your gateway up-to-date.

## Deploy multiple gateways

To achieve [high availability](#high-availability), deploy more gateways within
the same site.

You can deploy multiple gateways from the admin portal, or automate the process
by reusing the `FIREZONE_TOKEN` environment variable shown when deploying a
gateway from the admin portal.

When deploying a gateway from the admin portal, a `FIREZONE_TOKEN` environment
variable is shown. This variable can be reused to deploy multiple gateways
within the same site.

This means you can automate deployment of the gateway using your automation
method of choice, adding as many gateways as necessary for failover and load
balancing.

<Alert color="warning">
  **Note:** Be sure to set a unique `FIREZONE_ID` for each gateway you deploy.
  This can be any non-empty string and is used to identify the gateway in the
  portal for audit trail and logging purposes.
</Alert>

## High availability

Firezone was designed from the ground up to support high availability
requirements. This is achieved through a combination of **automatic failover**
and **load balancing**, both of which are automatically enabled on all plans.

### Automatic failover

Two or more gateways can be deployed within a site to achieve automatic failover
for client connections to resources in that site.

Here's how it works:

- When the admin portal detects a particular gateway is unhealthy, it will stop
  using it for new connection requests to resources in the site.
- Existing clients will remain connected to the gateway until they themselves
  detect it to be unhealthy.
- Clients detect unhealthy gateways by maintaining keepalive timers with
  gateways they're connected to. If the keepalive timer expires, the client will
  disconnect from that gateway and ask the portal for a new, healthy one to
  connect to.
- On average, the client keepalive timer expires after **20 seconds**. This is
  the maximum time it takes for existing client connections to be rerouted to a
  healthy gateway in the event of a gateway failure.

By using two independent health checks in the portal and the client, Firezone
ensures that temporary network issues or transient gateway failures do not
affect other clients connected to the same gateway.

### Load balancing

Similar to automatic failover, two or more gateways deployed within a site will
automatic load balance client connections to resources in that site.

When a client wants to connect to a resource, Firezone randomly picks a random
healthy gateway in the site to serve the resource being requested. The client
will then stay connected to that gateway until either the client disconnects or
the gateway becomes unhealthy.

Deploy as many gateways as you need to handle the load of client connections to
resources in a site. This effectively shards client connections across all
gateways in a site, achieving higher overall throughput than otherwise possible
with a single gateway.

<NextStep href="/kb/deploy/resources">Next: Resources</NextStep>

<SupportOptions />
